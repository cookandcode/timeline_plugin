SVG=function(a,b,c){var d=this;return this.element=document.createElementNS("http://www.w3.org/2000/svg",a),b.attributes&&_.forEach(b.attributes,function(a,b){if("function"==typeof a)var e=a.call(d.element);else var e=a;c?c(e,b,d.element):d.element.setAttribute(b,e)}),this.triggerAfterInsertCallback=function(){},b.afterCreate&&(this.triggerAfterInsertCallback=function(){b.afterCreate.call(this.element)}),this},SVG.createLine=function(a){var b=new SVG("line",a);return b},SVG.createRect=function(a){var b=new SVG("rect",a);return b},SVG.createSquare=function(a){return a.attributes.height=a.attributes.width,SVG.createRect(a)},SVG.createPath=function(a){var b=new SVG("path",a);return b},SVG.createText=function(a){var b=new SVG("text",a),c=new SVG("tspan",{});return console.log(b),c.element.textContent=a.text,b.element.appendChild(c.element),b},SVG.createTextArea=function(a){var b=new SVG("foreignObject",a),c=document.createElement("div"),d=["position:relative"];if(a.attributes&&a.attributes.width){if("function"==typeof a.attributes.width)var e=a.attributes.width();else var e=a.attributes.width;d.push("width:"+(e-30)+"px")}if(a.attributes&&a.attributes.stroke&&d.push("color:"+a.attributes.stroke),a.attributes&&a.attributes.background){d.push("background:"+a.attributes.background),d.push("padding: 10px 10px 10px 15px;"),d.push("border-radius: 5px;");var f=document.createElement("div");f.setAttribute("style","position: absolute; top: 50%; margin-top: -10px; border-top: 10px solid transparent; border-bottom: 10px solid transparent; left: 0; margin-left: -10px; border-right: 10px solid "+a.attributes.background)}return c.setAttribute("style",d.join(";")),c.innerHTML=a.html,void 0!=f&&c.appendChild(f),b.element.appendChild(c),b},SVG.createImage=function(a){var b=new SVG("image",a,function(a,b,c){"xlink:href"==b?c.setAttributeNS("http://www.w3.org/1999/xlink","href",a):c.setAttribute(b,a)});return b},SVG.createDefs=function(a){var b=new SVG("defs",a);return b},SVG.createPattern=function(a){var b=new SVG("pattern",a);return b},SVG.createGradient=function(a){var b=new SVG("linearGradient",a);return b},SVG.createStop=function(a){var b=new SVG("stop",a);return b};var Branch=function(a){return Branch=function(a,b,c){var d=this;if(this.month_gap=1.2e-8,this.squareWidth=20,this.beginningSquareWidth=40,this.curveSize=5,this.lineThickness=4,this.spaceBetweenBranch=500,this.color=a.color||"black",this.textColor=a.textColor||this.color,this.textBackground=a.textBackground||"rgba(0, 0, 0, 0)",this.heightFirstLine=200,"object"==typeof b&&(this.parent=b,this.branchSide=a.side),this.svg_div=c||this.parent.svg_div,this.name=a.name,this.img=a.img,this.events=a.events,this.isMaster=!this.parent,a.events.length>0){if("string"==typeof a.events[0].date)var e=a.events[0].date;else var e=a.events[0].date.start;this.event_beginning=new Date(Date.parse(e))}if(this.beginningDate=this.event_beginning-this.heightFirstLine/this.month_gap,this.isMaster){var f=(this.svg_div.offsetWidth-this.squareWidth)/2;this.beginning_position={top:b,left:f}}else this.calculateBeginningPosition();return this.parseEvents(),a.children&&(this.children=[],_.forEach(a.children,function(a){d.children.push(new Branch(a,d))})),this},Branch.prototype.getDefDiv=function(a){var b;return a&&(b=a),this.parent?(a&&(this.parent.defDiv=b),this.parent.defDiv):(a&&(this.defDiv=b),this.defDiv)},Branch.prototype.getGradient=function(){if(this.getDefDiv()||(this.getDefDiv(a.createDefs({})),this.svg_div.appendChild(this.getDefDiv().element)),!this.gradient){var b=a.createGradient({attributes:{id:"Gradient-"+this.getFirstDate()}});if("left"==this.branchSide)var c=a.createStop({attributes:{offset:"0%","stop-color":this.color}}),d=a.createStop({attributes:{offset:"60%","stop-color":this.parent.color}});else var c=a.createStop({attributes:{offset:"40%","stop-color":this.parent.color}}),d=a.createStop({attributes:{offset:"100%","stop-color":this.color}});b.element.appendChild(c.element),b.element.appendChild(d.element),this.gradient=b,this.getDefDiv().element.appendChild(this.gradient.element)}return this.gradient},Branch.prototype.calculateBeginningPosition=function(){var a=this.beginningDate-this.parent.beginningDate,b=this.parent.beginning_position.top+parseInt(a)*this.month_gap;if("left"==this.branchSide)var c=function(){return this.parent.beginning_position.left-this.spaceBetweenBranch};else var c=function(){return this.parent.beginning_position.left+this.spaceBetweenBranch};this.beginning_position={top:b,left:c.bind(this)}},Branch.prototype.getFirstDate=function(){return"string"==typeof this.events[0].date?this.events[0].date:this.events[0].date.start},Branch.prototype.getLeftBeginning=function(){if("function"==typeof this.beginning_position.left)var a=this.beginning_position.left();else var a=this.beginning_position.left;return this.beginningSquareWidth!=this.squareWidth?a-(this.beginningSquareWidth-this.squareWidth)/2:a},Branch.prototype.buildName=function(){var a=this,b=function(){return this.beginning_position.top-10};return{svgType:"Text",svgData:{text:this.name,attributes:{x:0,y:b.bind(this),fill:"transparent",stroke:this.color},afterCreate:function(){var b=a.getLeftBeginning()+(a.beginningSquareWidth+2*a.lineThickness-this.offsetWidth)/2;this.setAttribute("x",b)}}}},Branch.prototype.buildBeginning=function(a){var b=[],c=this.buildName();if(b.push(c),a){var d={svgType:"Image",svgData:{attributes:{x:0,y:0,"xlink:href":this.img,height:this.beginningSquareWidth,width:this.beginningSquareWidth,preserveAspectRatio:"xMinYMin slice"}}},e={svgType:"Pattern",svgData:{attributes:{id:this.getFirstDate(),width:100,height:100}},contain:d};b.push(e)}var f={svgType:"Square",svgData:{attributes:{rx:this.curveSize,x:this.getLeftBeginning.bind(this),y:this.beginning_position.top,width:this.beginningSquareWidth,fill:a?"url(#"+this.getFirstDate()+")":this.color,stroke:this.color,"stroke-width":this.lineThickness}}};return b.push(f),b},Branch.prototype.clearSVG=function(){this.svg_div.innerHTML="",delete this.gradient,delete this.defDiv,this.children&&_.forEach(this.children,function(a){a.clearSVG()})},Branch.prototype.parseEvents=function(){var a=this,b=function(){return this.parent?this.beginning_position.left():this.beginning_position.left},c=parseInt(this.beginning_position.top);_.forEach(this.events,function(d){d.parsedDate=Date.parse("string"==typeof d.date?d.date:d.date.start),c=function(){return _diff_month=d.parsedDate-this.beginningDate,this.beginning_position.top+parseInt(_diff_month)*this.month_gap},d.position={top:c.bind(a),left:b.bind(a)}})},Branch.prototype.buildIt=function(){var a=this;return this.eventsReadyToBuild=[],_.forEach(this.events,function(b){a.eventsReadyToBuild.push(a.buildEvent(b))}),this.children&&_.forEach(this.children,function(b){a.eventsReadyToBuild.push(b.buildIt())}),this.eventsReadyToBuild},Branch.prototype.updateMinX=function(a){this.parent?this.parent.updateMinX(a):(!this.minX||parseInt(a)<this.minX)&&(this.minX=parseInt(a))},Branch.prototype.updateMaxWidth=function(a,b){if(this.parent)this.parent.updateMaxWidth(a,b);else{var c=parseInt(a)+b;(!this.maxWidth||parseInt(c)>parseInt(this.maxWidth))&&(this.maxWidth=c)}},Branch.prototype.updateTotalHeight=function(a){this.parent?this.parent.updateTotalHeight(a):(!this.totalHeight||parseInt(a)>parseInt(this.totalHeight))&&(this.totalHeight=parseInt(a))},Branch.prototype.fullSquareSize=function(){return this.squareWidth+2*this.lineThickness},Branch.prototype.drawEvents=function(b,c){var d=this;b=b||this.eventsReadyToBuild;return b&&0!=b.length?void(Array.isArray(b)?_.forEach(b,function(a){d.drawEvents(a)}):b.svgType&&(svgElement=a["create"+b.svgType](b.svgData),c?(c.element.appendChild(svgElement.element),svgElement.triggerAfterInsertCallback()):(d.svg_div.appendChild(svgElement.element),svgElement.triggerAfterInsertCallback(),b.contain&&this.drawEvents(b.contain,svgElement)))):!1},Branch.prototype.buildEvent=function(a){var b=this,c=this.events.indexOf(a),d=[];if(0==c){d.push(this.buildBeginning());var e=function(){if("function"==typeof this.beginning_position.left)var a=this.beginning_position.left();else var a=this.beginning_position.left;return a+this.squareWidth/2},f=function(){return this.beginning_position.top+this.beginningSquareWidth}}else var e=function(){return this.events[c-1].position.left()+this.squareWidth/2},f=function(){return this.events[c-1].position.top()+this.squareWidth};var g=function(){return a.position.left()+this.squareWidth/2},h=function(){return a.position.top()};if(0==c&&this.parent){if("left"==this.branchSide)var i=function(){if("function"==typeof this.beginning_position.left)var a=this.beginning_position.left();else var a=this.beginning_position.left;return a+this.squareWidth/2};else var i=function(){if("function"==typeof this.beginning_position.left)var a=this.beginning_position.left();else var a=this.beginning_position.left;return a-this.spaceBetweenBranch+this.squareWidth/2};var j=function(){return this.beginning_position.top+this.beginningSquareWidth+this.squareWidth};d.push({svgType:"Rect",svgData:{attributes:{x:i.bind(this),y:j.bind(this),width:this.spaceBetweenBranch,height:this.lineThickness,fill:function(){return"url(#"+this.getGradient().element.id+")"}.bind(this)},afterCreate:function(){_.forEach(b.parent.events,function(a){var c=parseInt(this.getAttribute("y"));c>=a.position.top()&&c<=a.position.top()+b.squareWidth&&this.setAttribute("y",a.position.top()+b.squareWidth+b.squareWidth/2)}.bind(this))}}})}if(d.push({svgType:"Line",svgData:{attributes:{x1:e.bind(this),y1:f.bind(this),x2:g.bind(this),y2:h.bind(this),stroke:this.color,"stroke-width":this.lineThickness}}}),d.push({svgType:"Square",svgData:{attributes:{rx:this.curveSize,x:a.position.left,y:a.position.top,width:this.squareWidth,fill:"transparent",stroke:this.color,"stroke-width":this.lineThickness},afterCreate:function(){var a=parseInt(this.getAttribute("y")),c=this.offsetHeight;b.updateTotalHeight(a+c)}}}),"string"==typeof a.date){var k=new Date(a.parsedDate);eventText=k.toDateString(),d.push({svgType:"Text",svgData:{text:eventText,attributes:{width:this.squareWidth,fill:"transparent",stroke:this.textColor},afterCreate:function(){var c=a.position.left()-this.offsetWidth-20,d=a.position.top()+b.squareWidth/2+this.offsetHeight/2-b.lineThickness;this.setAttribute("x",c),this.setAttribute("y",d),b.updateMinX(c)}}})}else{var l=new Date(a.parsedDate),m=new Date(Date.parse(a.date.end)),n=10;d.push({svgType:"Text",svgData:{text:l.toDateString(),attributes:{width:this.squareWidth,fill:"transparent",stroke:this.textColor},afterCreate:function(){var c=a.position.left()-this.offsetWidth-10;this.setAttribute("x",c),this.setAttribute("y",a.position.top()+b.squareWidth/2-n/2),b.updateMinX(c)}}}),d.push({svgType:"Text",svgData:{text:m.toDateString(),attributes:{width:this.squareWidth,fill:"transparent",stroke:this.textColor},afterCreate:function(){var c=a.position.left()-this.offsetWidth-10;this.setAttribute("x",c);var d=this.previousSibling;this.setAttribute("y",parseInt(d.getAttribute("y"))+d.offsetHeight+n),b.updateMinX(c)}}})}var o=function(){if("function"==typeof this.beginning_position.left)var a=this.beginning_position.left();else var a=this.beginning_position.left;return a+this.squareWidth+20},p=function(){return this.spaceBetweenBranch/2-(o.bind(this)()-a.position.left())};return d.push({svgType:"TextArea",svgData:{html:a.content,attributes:{x:o.bind(this),width:p.bind(this),fill:"transparent",stroke:this.textColor,height:100,background:this.textBackground},afterCreate:function(){var c=this.childNodes[0].offsetHeight,d=a.position.top()+b.squareWidth/2-c/2;this.setAttribute("y",d),b.updateTotalHeight(d+c),b.updateMaxWidth(this.getAttribute("x"),this.offsetWidth)}}}),d},Branch}(SVG),Timeline=function(a){var b=function(b){var c=this,d=50,e=document.querySelectorAll("[create-timeline]")[0];return e?(this.theMasterBranch=null,this.svg_div=e,this.branches=[],this.beginningDate=new Date(Date.parse(b[0].events[0].date)),_.forEach(b,function(b){_top=d,_branch=new a(b,_top,e),c.branches.push(_branch),_branch.isMaster&&(c.theMasterBranch=_branch)}),this.buildIt(),this.drawIt(),this.svg_div.setAttribute("height",this.getHeight()),this.svg_div.setAttribute("width",this.getWidth()),this):void alert('no div with "create-timeline" attribute')};return b.prototype.buildIt=function(){_.forEach(this.branches,function(a){a.buildIt()})},b.prototype.drawIt=function(){_.forEach(this.branches,function(a){a.drawEvents(),a.minX<0&&(a.beginning_position.left+=-a.minX+10,a.clearSVG(),a.drawEvents())})},b.prototype.getWidth=function(){var a=0;return _.forEach(this.branches,function(b){b.maxWidth>a&&(a=b.maxWidth)}),a},b.prototype.getHeight=function(){var a=0;return _.forEach(this.branches,function(b){b.totalHeight>a&&(a=b.totalHeight+10)}),a+"px"},b}(Branch);